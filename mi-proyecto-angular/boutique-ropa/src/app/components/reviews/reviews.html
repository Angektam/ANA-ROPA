<div class="reviews-container">
  <!-- Review Stats -->
  <div class="reviews-stats" *ngIf="reviewStats">
    <div class="stats-overview">
      <div class="average-rating">
        <div class="rating-number">{{ getAverageRating() | number:'1.1-1' }}</div>
        <div class="rating-stars">
          <i *ngFor="let star of getStars(getAverageRating())" [class]="star"></i>
        </div>
        <div class="rating-text">{{ getTotalReviews() }} {{ getTotalReviews() === 1 ? 'reseña' : 'reseñas' }}</div>
      </div>
      
      <div class="rating-breakdown">
        <div class="rating-bar" *ngFor="let rating of [5,4,3,2,1]">
          <span class="rating-label">{{ rating }}★</span>
          <div class="bar-container">
            <div class="bar-fill" [style.width.%]="getRatingPercentage(rating)"></div>
          </div>
          <span class="rating-count">{{ getRatingCount(rating) }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Review Actions -->
  <div class="reviews-actions">
    <div class="actions-left">
      <h3 class="reviews-title">
        <i class="fas fa-star"></i>
        Reseñas de Clientes
      </h3>
      <span class="reviews-count" *ngIf="reviewStats">
        {{ getTotalReviews() }} {{ getTotalReviews() === 1 ? 'reseña' : 'reseñas' }}
      </span>
    </div>
    
    <div class="actions-right">
      <button 
        class="btn-write-review" 
        (click)="toggleReviewForm()"
        *ngIf="isAuthenticated && !hasUserReviewed">
        <i class="fas fa-pen"></i>
        <span>Escribir Reseña</span>
      </button>
      
      <button 
        class="btn-edit-review" 
        (click)="toggleReviewForm()"
        *ngIf="isAuthenticated && hasUserReviewed">
        <i class="fas fa-edit"></i>
        <span>Editar Reseña</span>
      </button>
      
      <button 
        class="btn-login-review" 
        *ngIf="!isAuthenticated">
        <i class="fas fa-sign-in-alt"></i>
        <span>Iniciar Sesión para Reseñar</span>
      </button>
    </div>
  </div>

  <!-- Review Form -->
  <div class="review-form-container" *ngIf="showReviewForm">
    <div class="review-form">
      <div class="form-header">
        <h4>{{ hasUserReviewed ? 'Editar tu Reseña' : 'Escribir Reseña' }}</h4>
        <button class="btn-close-form" (click)="toggleReviewForm()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <form (ngSubmit)="hasUserReviewed ? updateReview() : submitReview()">
        <!-- Rating -->
        <div class="form-group">
          <label class="form-label">Calificación</label>
          <div class="rating-input">
            <button 
              type="button"
              *ngFor="let star of [1,2,3,4,5]"
              class="star-btn"
              [class.active]="star <= newReview.rating"
              (click)="setRating(star)">
              <i class="fas fa-star"></i>
            </button>
            <span class="rating-text">{{ newReview.rating }} {{ newReview.rating === 1 ? 'estrella' : 'estrellas' }}</span>
          </div>
        </div>

        <!-- Title -->
        <div class="form-group">
          <label for="review-title" class="form-label">Título de la Reseña</label>
          <input
            type="text"
            id="review-title"
            [(ngModel)]="newReview.title"
            class="form-input"
            placeholder="Resume tu experiencia..."
            maxlength="100"
            required>
        </div>

        <!-- Comment -->
        <div class="form-group">
          <label for="review-comment" class="form-label">Comentario</label>
          <textarea
            id="review-comment"
            [(ngModel)]="newReview.comment"
            class="form-textarea"
            placeholder="Comparte tu experiencia con este producto..."
            rows="4"
            maxlength="500"
            required></textarea>
          <div class="char-count">{{ (newReview.comment || '').length }}/500</div>
        </div>

        <!-- Submit Buttons -->
        <div class="form-actions">
          <button 
            type="button" 
            class="btn-cancel" 
            (click)="toggleReviewForm()">
            Cancelar
          </button>
          
          <button 
            type="submit" 
            class="btn-submit"
            [disabled]="isLoading || !isFormValid()">
            <span *ngIf="!isLoading">
              {{ hasUserReviewed ? 'Actualizar Reseña' : 'Publicar Reseña' }}
            </span>
            <span *ngIf="isLoading" class="loading-content">
              <i class="fas fa-spinner fa-spin"></i>
              {{ hasUserReviewed ? 'Actualizando...' : 'Publicando...' }}
            </span>
          </button>
          
          <button 
            type="button" 
            class="btn-delete" 
            (click)="deleteReview()"
            *ngIf="hasUserReviewed">
            <i class="fas fa-trash"></i>
            Eliminar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Reviews List -->
  <div class="reviews-list" *ngIf="!isLoading">
    <div class="review-item" *ngFor="let review of reviews">
      <div class="review-header">
        <div class="reviewer-info">
          <div class="reviewer-avatar">
            <i class="fas fa-user-circle"></i>
          </div>
          <div class="reviewer-details">
            <div class="reviewer-name">{{ review.user?.name || 'Usuario Anónimo' }}</div>
            <div class="review-date">{{ formatReviewDate(review.createdAt || '') }}</div>
          </div>
        </div>
        
        <div class="review-rating">
          <div class="stars">
            <i *ngFor="let star of getStars(review.rating)" [class]="star"></i>
          </div>
          <span class="rating-number">{{ review.rating }}</span>
        </div>
      </div>
      
      <div class="review-content">
        <h4 class="review-title" *ngIf="review.title">{{ review.title }}</h4>
        <p class="review-comment">{{ review.comment }}</p>
      </div>
      
      <div class="review-footer">
        <div class="review-meta">
          <span class="verified-badge" *ngIf="review.isVerified">
            <i class="fas fa-check-circle"></i>
            Compra Verificada
          </span>
        </div>
        
        <div class="review-actions">
          <button class="btn-helpful">
            <i class="fas fa-thumbs-up"></i>
            <span>Útil</span>
          </button>
          
          <button class="btn-report" (click)="reportReview(review.id)">
            <i class="fas fa-flag"></i>
            <span>Reportar</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="isLoading">
    <div class="loading-spinner">
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
      <div class="spinner-ring"></div>
    </div>
    <p class="loading-text">Cargando reseñas...</p>
  </div>

  <!-- Empty State -->
  <div class="empty-reviews" *ngIf="!isLoading && reviews.length === 0">
    <div class="empty-content">
      <i class="fas fa-star"></i>
      <h3>No hay reseñas aún</h3>
      <p>Sé el primero en compartir tu experiencia con este producto</p>
      <button 
        class="btn-write-first-review" 
        (click)="toggleReviewForm()"
        *ngIf="isAuthenticated">
        <i class="fas fa-pen"></i>
        <span>Escribir Primera Reseña</span>
      </button>
    </div>
  </div>
</div>
